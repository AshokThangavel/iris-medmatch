ARG IMAGE=intersystemsdc/irishealth-community
FROM $IMAGE as builder

USER root

# Install system dependencies for Python
RUN apt-get update && apt-get install -y python3-pip && rm -rf /var/lib/apt/lists/*

# Install AI libraries into the IRIS python directory
# This is crucial so that 'Do ##class(%SYS.Python).Import("sentence_transformers")' works
RUN python3 -m pip install --target /usr/irissys/mgr/python sentence-transformers

# Create app directory and set permissions
# Create the directory
WORKDIR /home/irisowner/dev
RUN chown irisowner:irisowner /home/irisowner/dev

# Copy everything from your local 'backend' folder into '/home/irisowner/dev'
COPY --chown=irisowner:irisowner . ./

USER irisowner

ENV IRISUSERNAME "_SYSTEM" \
    IRISPASSWORD "SYS" \
    PYTHON_PATH=/usr/bin/python3 \
    PATH "/usr/irissys/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin:/home/irisowner/bin"


USER ${ISC_PACKAGE_MGRUSER}
RUN iris start IRIS \
    && iris session IRIS < iris.script | tee /home/irisowner/dev/build.log \
    && iris stop IRIS quietly